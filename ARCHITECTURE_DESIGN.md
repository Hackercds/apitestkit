# API测试框架新架构设计

## 1. 架构概述

### 1.1 设计目标
- **自动化测试支持**：支持基本的正常场景和异常场景自动化测试
- **Agent集成**：能够接受Agent相关接口参数进行自动化测试
- **复杂场景处理**：支持多接口场景、异步接口、大模型流式接口等
- **完整测试流程**：支持before/after等测试流程控制
- **可靠的日志系统**：区分用户日志和框架日志，详细记录所有关键操作
- **易用性**：提供简洁明了的API和完善的文档
- **大模型API测试增强**：优化对大模型API的测试支持
- **流式响应处理**：提供高效的流式响应处理能力

### 1.2 核心组件

```
apitestkit/
├── adapter/              # API适配器层
│   ├── api_adapter.py    # 核心API适配器
│   ├── async_adapter.py  # 异步接口适配器
│   ├── stream_adapter.py # 流式接口适配器
│   └── agent_adapter.py  # Agent接口适配器
│
├── assertion/            # 断言系统
│   ├── assertions.py     # 核心断言功能
│   ├── schema_validator.py # 模式验证
│   └── custom_assertions.py # 自定义断言
│
├── core/                 # 核心组件
│   ├── config.py         # 配置管理
│   ├── logger.py         # 日志系统
│   └── utils.py          # 工具函数
│
├── test/                 # 测试管理
│   ├── test_case.py      # 测试用例定义
│   ├── test_suite.py     # 测试套件
│   ├── test_runner.py    # 测试运行器
│   └── test_hooks.py     # 测试钩子（before/after）
│
├── data/                 # 数据处理
│   ├── data_generator.py # 测试数据生成器
│   ├── data_manager.py   # 数据管理
│   └── validator.py      # 数据验证
│
├── auth/                 # 认证系统
│   ├── auth_manager.py   # 认证管理
│   └── auth_methods.py   # 各种认证方法
│
├── scenario/             # 场景管理
│   ├── scenario.py       # 场景定义
│   └── scenario_runner.py # 场景运行器
│
└── reporter/             # 报告系统
    ├── report_generator.py # 报告生成
    └── report_formatters.py # 报告格式化
```

## 2. 模块详细设计

### 2.1 适配器层

#### 2.1.1 ApiAdapter
- **功能**：处理标准HTTP请求
- **特性**：
  - 支持所有HTTP方法（GET, POST, PUT, DELETE等）
  - 支持请求参数、头部、Cookie等
  - 支持文件上传
  - 支持超时设置
  - 支持请求重试

#### 2.1.2 AsyncAdapter
- **功能**：处理异步HTTP请求
- **特性**：
  - 基于async/await的异步接口
  - 支持并行请求
  - 支持异步响应处理

#### 2.1.3 StreamAdapter
- **功能**：处理流式接口（如大模型流式响应）
- **特性**：
  - 实时接收流数据
  - 支持流数据处理和验证
  - 支持流数据保存
  - 支持SSE和JSON格式的流式数据处理
  - 提供流式数据块提取和分析功能

#### 2.1.4 AgentAdapter
- **功能**：为AI Agent提供专用接口
- **特性**：
  - 支持Agent专用参数格式
  - 支持对话历史管理
  - 支持上下文维护
  - 提供Agent参数模板系统
  - 简化大模型API测试流程

### 2.2 断言系统

#### 2.2.1 核心断言
- 状态码断言
- 响应时间断言
- 头部断言
- JSON路径断言
- JSON Schema验证
- 内容包含断言

#### 2.2.2 自定义断言
- 支持用户定义的断言函数
- 断言组合和条件断言

### 2.3 测试管理

#### 2.3.1 测试用例
- 测试步骤定义
- 断言集合
- 数据驱动支持
- 参数化测试

#### 2.3.2 测试套件
- 测试用例组织
- 测试执行顺序控制
- 测试过滤和分组

#### 2.3.3 测试钩子
- before_all, after_all
- before_each, after_each
- before_step, after_step

#### 2.3.4 测试场景
- 多接口组合场景
- 依赖接口场景
- 复杂业务流程场景

### 2.4 日志系统

- **框架日志**：记录框架内部运行状态
- **用户日志**：记录用户定义的日志
- **测试日志**：记录测试执行过程
- **支持多种日志级别和格式**
- **支持日志文件分割和轮转**

### 2.5 配置系统

- **全局配置**
- **测试级别配置**
- **环境配置切换**
- **配置文件支持（YAML, JSON）**
- **环境变量覆盖支持**

## 3. 工作流程

### 3.1 测试执行流程
1. 加载配置
2. 初始化日志系统
3. 执行before_all钩子
4. 遍历测试套件和测试用例
   - 执行before_each钩子
   - 遍历测试步骤
     - 执行before_step钩子
     - 执行API请求
     - 执行断言
     - 执行after_step钩子
   - 执行after_each钩子
5. 执行after_all钩子
6. 生成测试报告

### 3.2 复杂场景处理流程
1. 场景初始化
2. 按顺序执行场景中的接口
3. 接口间数据传递
4. 异步接口处理
5. 流式接口处理
6. 场景级断言

### 3.3 Agent API测试流程
1. 创建AgentAdapter实例
2. 配置Agent参数（提示词、对话历史、模型选项等）
3. 设置请求参数
4. 发送请求
5. 处理响应
6. 执行断言
7. 返回结果

### 3.4 流式响应处理流程
1. 启用流式响应处理
2. 设置流式处理器和格式选项
3. 发送请求
4. 实时处理流式数据块
5. 从流式数据中提取变量（可选）
6. 对流式数据执行断言（可选）
7. 聚合完整流式内容
8. 返回结果

## 4. Agent集成设计

### 4.1 Agent接口支持
- 支持标准Agent接口参数格式
- 支持对话历史管理
- 支持上下文维护
- 支持多轮对话场景

### 4.2 自动化测试能力
- 基于参数的自动测试生成
- 异常场景自动覆盖
- 测试结果自动分析

## 5. 扩展性设计

### 5.1 插件系统
- 支持自定义适配器
- 支持自定义断言
- 支持自定义报告格式
- 支持自定义数据源

### 5.2 事件系统
- 测试事件发布订阅
- 自定义事件处理

### 5.3 Agent接口参数模板
- 支持创建和使用Agent接口参数模板
- 提供常见大模型API的参数模板
- 支持模板继承和覆盖

## 6. 技术选型

- **核心语言**：Python 3.8+
- **HTTP客户端**：requests, httpx (异步支持)
- **数据处理**：json, yaml, pydantic
- **并发支持**：asyncio
- **日志系统**：logging + 自定义扩展
- **测试框架集成**：pytest兼容

## 7. 后续优化方向

- 性能优化：支持更多并发和更大规模测试
- 可视化界面：提供Web界面进行测试管理
- CI/CD集成：更好地与持续集成系统集成
- AI增强：利用AI自动生成测试用例和分析测试结果
- 增加更多大模型API的适配
- 增强流式响应处理能力
- 增加模型输出评估功能